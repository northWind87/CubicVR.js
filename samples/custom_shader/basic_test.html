<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
    
    <head>
        <title>
            CubicVR.js: Basic Textured Cube with Custom Shader
        </title>
        <script src="../../CubicVR.js" type="text/javascript">
        </script>
        <script id="vs" type="x-shader/x-vertex">
            uniform float left;
            uniform float top;
            uniform float width;
            uniform float height;
            varying float linearCorrection;
            varying vec2 screenPos;
            varying float radius;

            void main() {
                vertexTexCoordOut = cubicvr_texCoord();
                gl_Position = matrixProjection * matrixModelView * cubicvr_transform();
                vertexNormalOut = matrixNormal * cubicvr_normal();

                gl_PointSize = 20.0;

                // Convert position to window coordinates
                vec2 halfsize = vec2(width * 0.5, height * 0.5);
                vec2 topLeft = vec2(top, left);
                linearCorrection = 1.0 / gl_Position.w;
                //screenPos = topLeft + halfsize + ((gl_Position.xy * gl_Position.w) * halfsize);
                screenPos = (topLeft + halfsize + ((gl_Position.xy / gl_Position.w) * halfsize)) * gl_Position.w;

                radius = gl_PointSize * 0.5;
            }
        </script>
        <script id="fs" type="x-shader/x-fragment">
            varying float linearCorrection;
            varying vec2 screenPos;
            varying float radius;

            void main() {
                vec2 sp = screenPos * linearCorrection;
                if( distance(gl_FragCoord.xy, sp) > radius ) discard;
                //if( distance(gl_FragCoord.xy, sp) > radius ) discard;
                //gl_FragData[0] = vec4(cubicvr_color(cubicvr_texCoord()).rgb * clamp(distance(gl_FragCoord.xy, sp) * 0.1, 0.0, 1.0), 1.0);
                gl_FragData[0] = cubicvr_color(cubicvr_texCoord());
            }
        </script>
        <script type='text/javascript'>
        
            function webGLStart() {
              // by default generate a full screen canvas with automatic resize
               var gl = CubicVR.init();
               var canvas = CubicVR.getCanvas();

                if (!gl) {
                    alert("Sorry, no WebGL support.");
                    return;
                };
               
                // Create a camera, position at 1,1,1 and target at 0,0,0
                var scene = new CubicVR.Scene(canvas.width,canvas.height,60);
                var camera = scene.camera;
                camera.position = [1,1,1];
                camera.lookat([0,0,0]);

                var myShader = new CubicVR.CustomShader({
                    vertex: "#vs",
                    fragment: "#fs"
                });

                // Add a box to mesh, size 1.0, apply material and UV parameters
                var boxMesh = new CubicVR.Mesh({
                    primitive: {
                        type: "box",
                        size: 1.0,
                        material: {
                            textures: {
                                color: "../images/6583-diffuse.jpg",
                            },
                            shader: myShader
                        },
                        uv: {
                            projectionMode: "cubic",
                            scale: [1, 1, 1]
                        }
                    },
                    compile: true
                });

                var boxObject = new CubicVR.SceneObject(boxMesh);

                scene.bind(boxObject);

                // Add our camera to the window resize list
                CubicVR.addResizeable(scene);

                // Start our main drawing loop, it provides a timer and the gl context as parameters
                CubicVR.MainLoop(function(timer, gl) {
                    if (myShader.ready()) { // shader var bindings updated automatically when update() not set.  ready() ensures successful compile of shader.
                        myShader.left.value = 0;
                        myShader.top.value = 0;
                        myShader.width.value = canvas.width;
                        myShader.height.value = canvas.height;
                    } 
                    // Render our object using the camera, pass identity matrix to represent no transform
                    scene.render();
                });

                mvc = new CubicVR.MouseViewController(canvas, scene.camera);
            }
        </script>
    </head>
    
    <body onLoad="webGLStart();"></body>

</html>
